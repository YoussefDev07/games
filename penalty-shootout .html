<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„Ø¹Ø¨Ø© Ø¶Ø±Ø¨Ø§Øª Ø§Ù„Ø¬Ø²Ø§Ø¡</title>
    <!-- ØªØ¶Ù…ÙŠÙ† Ø®Ø· Ù…Ù†Ø§Ø³Ø¨ ÙŠØ¯Ø¹Ù… Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© ÙˆØ§Ù„ØªØµÙ…ÙŠÙ… Ø§Ù„Ø¬Ø°Ø§Ø¨ -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* Ø£Ù†Ù…Ø§Ø· CSS Ù…Ø®ØµØµØ© Ù„Ù„Ø¹Ø¨Ø© */
        :root {
            --green-field: #4CAF50;
            --white-lines: #ffffff;
            --blue-sky: #87CEEB;
            --ball-color: #333333;
            --text-color: #1a1a1a;
            --header-bg: #2C3E50;
            --header-text: #ECF0F1;
            --primary-button: #E74C3C;
            --primary-hover: #C0392B;
        }

        body {
            font-family: 'Cairo', sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background-color: #F4F4F4; /* Ø®Ù„ÙÙŠØ© Ø®ÙÙŠÙØ© */
        }

        .game-container {
            background-color: #FFFFFF;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            border-radius: 20px;
            padding: 20px;
            width: 95%;
            max-width: 600px;
            margin: 20px auto;
            text-align: center;
        }

        h1 {
            color: var(--header-bg);
            margin-top: 0;
            font-weight: 700;
        }

        canvas {
            display: block;
            background-color: var(--blue-sky); /* Ø³Ù…Ø§Ø¡ */
            border: 5px solid #bdc3c7;
            border-radius: 10px;
            touch-action: manipulation; /* Ù„ØªØ­Ø³ÙŠÙ† Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ø§Ù„Ù„Ù…Ø³ */
            width: 100%; /* Ø§Ø¬Ø¹Ù„ Ø§Ù„ÙƒØ§Ù†ÙØ§Ø³ ÙŠØªÙƒÙŠÙ Ù…Ø¹ Ø§Ù„Ø¹Ø±Ø¶ */
            height: auto; /* Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„Ù†Ø³Ø¨Ø© */
            max-height: 400px;
        }

        .score-board {
            display: flex;
            justify-content: space-around;
            margin: 15px 0;
            padding: 10px;
            background-color: var(--header-bg);
            color: var(--header-text);
            border-radius: 10px;
            font-size: 1.2rem;
        }

        .message-box {
            min-height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 15px 0;
            padding: 10px;
            background-color: #ECF0F1;
            color: var(--text-color);
            border-radius: 10px;
            font-weight: 700;
        }

        button {
            background-color: var(--primary-button);
            color: var(--header-text);
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: 700;
            transition: background-color 0.3s, transform 0.1s;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            display: none; /* ÙŠØªÙ… Ø¥Ø¸Ù‡Ø§Ø±Ù‡ ÙÙ‚Ø· Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø§Ø¬Ø© */
            margin-top: 10px;
        }

        button:hover {
            background-color: var(--primary-hover);
            transform: translateY(-2px);
        }

        button:active {
            transform: translateY(0);
        }

        /* Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ø§Ù„Ù„Ø¹Ø¨Ø© Ù„Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„ØµØºÙŠØ±Ø© */
        @media (max-width: 480px) {
            .game-container {
                padding: 10px;
                margin: 10px auto;
            }
            h1 {
                font-size: 1.5rem;
            }
            .score-board {
                font-size: 1rem;
            }
            button {
                padding: 10px 20px;
                font-size: 1rem;
            }
        }
    </style>
</head>
<body>

<div class="game-container">
    <h1>ğŸ† Ø¶Ø±Ø¨Ø§Øª Ø§Ù„Ø¬Ø²Ø§Ø¡ âš½</h1>
    
    <div class="score-board">
        <div>Ø§Ù„Ø£Ù‡Ø¯Ø§Ù: <span id="player-score">0</span></div> <!-- ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ« Ù‡Ù†Ø§: Ø§Ù„Ù†ØªÙŠØ¬Ø© -> Ø§Ù„Ø£Ù‡Ø¯Ø§Ù -->
        <div>Ø¬ÙˆÙ„Ø§Øª: <span id="round-count">1 / 5</span></div>
    </div>

    <canvas id="penaltyCanvas"></canvas>

    <div class="message-box" id="message-box">
        Ø§Ù†Ù‚Ø± (Ø£Ùˆ Ø§Ù„Ù…Ø³ Ø§Ù„Ø´Ø§Ø´Ø©) Ù„ØªØ­Ø¯ÙŠØ¯ Ù‡Ø¯Ù Ø§Ù„ØªØ³Ø¯ÙŠØ¯!
    </div>

    <button id="restart-button">Ø¥Ø¹Ø§Ø¯Ø© Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø©</button>
</div>

<script>
    // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¹Ù†Ø§ØµØ± Canvas Ùˆ DOM
    const canvas = document.getElementById('penaltyCanvas');
    const ctx = canvas.getContext('2d');
    const playerScoreEl = document.getElementById('player-score');
    const roundCountEl = document.getElementById('round-count');
    const messageBox = document.getElementById('message-box');
    const restartButton = document.getElementById('restart-button');

    // Ø¥Ø¹Ø¯Ø§Ø¯ Ø£Ø¨Ø¹Ø§Ø¯ Ø§Ù„Ù„Ø¹Ø¨Ø© (Ø§Ù„Ù‚ÙŠØ§Ø³Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©)
    const GAME_WIDTH = 500;
    const GAME_HEIGHT = 400;
    
    canvas.width = GAME_WIDTH;
    canvas.height = GAME_HEIGHT;

    // Ø«ÙˆØ§Ø¨Øª Ø§Ù„Ù„Ø¹Ø¨Ø© ÙˆØ­Ø§Ù„Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©
    const MAX_ROUNDS = 5;
    let gameState = {
        score: 0,
        round: 1,
        phase: 'aiming', // Ø§Ù„Ù…Ø±Ø§Ø­Ù„: 'aiming', 'shooting', 'result'
        ball: { x: GAME_WIDTH / 2, y: GAME_HEIGHT - 30, radius: 10, targetX: null, targetY: null, velocityX: 0, velocityY: 0, active: false, initialY: GAME_HEIGHT - 30 },
        keeper: { x: GAME_WIDTH / 2, y: 75, width: 60, height: 80, saveX: null, saveY: null, isSaving: false },
        animationFrame: null // Ù„ØªØªØ¨Ø¹ Ø¥Ø·Ø§Ø± Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ù…ØªØ­Ø±ÙƒØ©
    };

    // ----------------------
    // ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ø±Ø³Ù… (Drawing Functions)
    // ----------------------

    /**
     * Ø±Ø³Ù… Ø§Ù„Ù…Ù„Ø¹Ø¨ ÙˆØ§Ù„Ù‡Ø¯Ù.
     */
    function drawField() {
        // Ø®Ù„ÙÙŠØ© Ø§Ù„Ù…Ù„Ø¹Ø¨ (Ø§Ù„Ø¹Ø´Ø¨)
        ctx.fillStyle = '#4CAF50'; 
        ctx.fillRect(0, 150, GAME_WIDTH, GAME_HEIGHT - 150);
        
        // Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø¬Ø²Ø§Ø¡ (Ø£Ø®Ø¶Ø± Ø£ÙØªØ­ Ù‚Ù„ÙŠÙ„Ø§Ù‹)
        ctx.fillStyle = '#66BB6A';
        ctx.fillRect(GAME_WIDTH / 2 - 150, 200, 300, GAME_HEIGHT - 200);

        // Ø®Ø· Ø§Ù„Ù…Ø±Ù…Ù‰
        ctx.strokeStyle = '#ffffff';
        ctx.lineWidth = 4;
        ctx.beginPath();
        ctx.moveTo(0, GAME_HEIGHT - 40);
        ctx.lineTo(GAME_WIDTH, GAME_HEIGHT - 40);
        ctx.stroke();

        // Ù†Ù‚Ø·Ø© Ø§Ù„Ø¬Ø²Ø§Ø¡ (Ball initial position)
        ctx.fillStyle = '#ffffff';
        ctx.beginPath();
        ctx.arc(gameState.ball.x, gameState.ball.initialY, 3, 0, Math.PI * 2);
        ctx.fill();

        // Ø§Ù„Ù…Ø±Ù…Ù‰ (Goal Posts and Net)
        ctx.strokeStyle = '#333333';
        ctx.lineWidth = 10;
        ctx.lineCap = 'round';
        ctx.beginPath();
        // Ø§Ù„Ø¹Ø§Ø±Ø¶Ø©
        ctx.moveTo(GAME_WIDTH / 2 - 100, 40);
        ctx.lineTo(GAME_WIDTH / 2 + 100, 40);
        // Ø§Ù„Ù‚Ø§Ø¦Ù… Ø§Ù„Ø£ÙŠÙ…Ù†
        ctx.moveTo(GAME_WIDTH / 2 + 100, 40);
        ctx.lineTo(GAME_WIDTH / 2 + 100, 100);
        // Ø§Ù„Ù‚Ø§Ø¦Ù… Ø§Ù„Ø£ÙŠØ³Ø±
        ctx.moveTo(GAME_WIDTH / 2 - 100, 40);
        ctx.lineTo(GAME_WIDTH / 2 - 100, 100);
        ctx.stroke();

        // Ø´Ø¨ÙƒØ© Ø§Ù„Ù…Ø±Ù…Ù‰
        ctx.strokeStyle = 'rgba(255, 255, 255, 0.5)';
        ctx.lineWidth = 1;
        // Ø®Ø·ÙˆØ· Ø£ÙÙ‚ÙŠØ©
        for (let y = 45; y < 100; y += 10) {
            ctx.beginPath();
            ctx.moveTo(GAME_WIDTH / 2 - 100, y);
            ctx.lineTo(GAME_WIDTH / 2 + 100, y);
            ctx.stroke();
        }
        // Ø®Ø·ÙˆØ· Ø¹Ù…ÙˆØ¯ÙŠØ©
        for (let x = GAME_WIDTH / 2 - 95; x < GAME_WIDTH / 2 + 100; x += 10) {
            ctx.beginPath();
            ctx.moveTo(x, 40);
            ctx.lineTo(x, 100);
            ctx.stroke();
        }
    }

    /**
     * Ø±Ø³Ù… Ø§Ù„ÙƒØ±Ø© ÙÙŠ Ù…ÙˆÙ‚Ø¹Ù‡Ø§ Ø§Ù„Ø­Ø§Ù„ÙŠ.
     */
    function drawBall() {
        ctx.fillStyle = gameState.ball.active ? '#1A1A1A' : '#333333';
        ctx.beginPath();
        ctx.arc(gameState.ball.x, gameState.ball.y, gameState.ball.radius, 0, Math.PI * 2);
        ctx.fill();
        
        // Ø¥Ø¶Ø§ÙØ© Ø¨Ø¹Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ù„Ù„ÙƒØ±Ø©
        ctx.strokeStyle = '#ffffff';
        ctx.lineWidth = 1;
        ctx.beginPath();
        ctx.arc(gameState.ball.x - 3, gameState.ball.y - 3, 2, 0, Math.PI * 2);
        ctx.stroke();
    }

    /**
     * Ø±Ø³Ù… Ø­Ø§Ø±Ø³ Ø§Ù„Ù…Ø±Ù…Ù‰.
     */
    function drawKeeper() {
        const k = gameState.keeper;
        
        // Ø¬Ø³Ù… Ø§Ù„Ø­Ø§Ø±Ø³ (Body)
        ctx.fillStyle = '#3498DB'; // Ø²ÙŠ Ø£Ø²Ø±Ù‚
        ctx.fillRect(k.x - k.width / 2, k.y, k.width, k.height);
        
        // Ø±Ø£Ø³ Ø§Ù„Ø­Ø§Ø±Ø³ (Head)
        ctx.fillStyle = '#F4D03F'; // Ù„ÙˆÙ† Ø§Ù„Ø¨Ø´Ø±Ø© / Ø§Ù„Ø´Ø¹Ø±
        ctx.beginPath();
        ctx.arc(k.x, k.y, k.width / 4, 0, Math.PI * 2);
        ctx.fill();
        
        // Ø§Ù„Ø£ÙŠØ¯ÙŠ (Arms) - ØªØ¨Ø¯Ùˆ ÙˆÙƒØ£Ù†Ù‡Ø§ Ù…ØªØ¬Ù‡Ø© Ù„Ù„Ø£Ø¹Ù„Ù‰ Ù‚Ù„ÙŠÙ„Ø§Ù‹
        ctx.fillStyle = '#2C3E50'; // Ù„ÙˆÙ† Ø§Ù„Ù‚ÙØ§Ø²Ø§Øª
        const armLength = k.height / 2;
        const armWidth = 10;
        
        // Ø§Ù„Ø°Ø±Ø§Ø¹ Ø§Ù„Ø£ÙŠØ³Ø±
        ctx.fillRect(k.x - k.width / 2 - armWidth, k.y + 10, armWidth, armLength);
        // Ø§Ù„Ø°Ø±Ø§Ø¹ Ø§Ù„Ø£ÙŠÙ…Ù†
        ctx.fillRect(k.x + k.width / 2, k.y + 10, armWidth, armLength);
    }

    /**
     * Ø±Ø³Ù… Ø§Ù„Ù…Ø¤Ø´Ø± Ø§Ù„Ù…Ø³ØªÙ‡Ø¯Ù (Target Marker) Ø¥Ø°Ø§ ÙƒØ§Ù† ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„ØªØµÙˆÙŠØ¨.
     */
    function drawTarget() {
        if (gameState.ball.targetX !== null && gameState.phase === 'aiming') {
            const tx = gameState.ball.targetX;
            const ty = gameState.ball.targetY;
            
            ctx.strokeStyle = 'rgba(231, 76, 60, 0.8)'; // Ø£Ø­Ù…Ø± Ø´ÙØ§Ù
            ctx.lineWidth = 2;
            ctx.setLineDash([5, 5]); // Ø®Ø· Ù…ØªÙ‚Ø·Ø¹
            
            // Ø±Ø³Ù… Ø¹Ù„Ø§Ù…Ø© X
            ctx.beginPath();
            ctx.moveTo(tx - 10, ty - 10);
            ctx.lineTo(tx + 10, ty + 10);
            ctx.moveTo(tx + 10, ty - 10);
            ctx.lineTo(tx - 10, ty + 10);
            ctx.stroke();
            
            ctx.setLineDash([]); // Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· Ø§Ù„Ø®Ø· Ø¥Ù„Ù‰ ØµÙ„Ø¨
        }
    }

    // ----------------------
    // ÙˆØ¸Ø§Ø¦Ù Ù…Ù†Ø·Ù‚ Ø§Ù„Ù„Ø¹Ø¨Ø© (Game Logic Functions)
    // ----------------------

    /**
     * ØªÙ‡ÙŠØ¦Ø© ÙˆØ¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù„Ø¹Ø¨Ø© Ù„Ø¬ÙˆÙ„Ø© Ø¬Ø¯ÙŠØ¯Ø©.
     */
    function resetRound() {
        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„ÙƒØ±Ø© Ø¥Ù„Ù‰ Ù†Ù‚Ø·Ø© Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©
        gameState.ball.x = GAME_WIDTH / 2;
        gameState.ball.y = gameState.ball.initialY;
        gameState.ball.targetX = null;
        gameState.ball.targetY = null;
        gameState.ball.velocityX = 0;
        gameState.ball.velocityY = 0;
        gameState.ball.active = false;
        
        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø­Ø§Ø±Ø³ Ø§Ù„Ù…Ø±Ù…Ù‰ Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø±ÙƒØ²
        gameState.keeper.x = GAME_WIDTH / 2;
        gameState.keeper.saveX = null;
        gameState.keeper.isSaving = false;
        
        // ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„ØªØ§Ù„ÙŠØ©
        gameState.phase = 'aiming';
        
        // ØªØ­Ø¯ÙŠØ« ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        updateUI();
        
        // Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨Ø§Ù„ØªÙØ§Ø¹Ù„
        canvas.addEventListener('click', handleInput);
        canvas.addEventListener('touchstart', handleInput);
        restartButton.style.display = 'none';
        
        if (gameState.round > MAX_ROUNDS) {
            endGame();
        } else {
             messageBox.textContent = `Ø§Ù„Ø¬ÙˆÙ„Ø© ${gameState.round}: Ø§Ù†Ù‚Ø± (Ø£Ùˆ Ø§Ù„Ù…Ø³ Ø§Ù„Ø´Ø§Ø´Ø©) Ù„ØªØ­Ø¯ÙŠØ¯ Ù‡Ø¯Ù Ø§Ù„ØªØ³Ø¯ÙŠØ¯!`;
        }
    }

    /**
     * ØªØ­Ø¯ÙŠØ« Ø´Ø§Ø´Ø© Ø§Ù„Ù†ØªÙŠØ¬Ø© ÙˆÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù….
     */
    function updateUI() {
        playerScoreEl.textContent = gameState.score;
        roundCountEl.textContent = `${gameState.round} / ${MAX_ROUNDS}`;
    }

    /**
     * Ù…Ø¹Ø§Ù„Ø¬Ø© Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Ø§Ù„Ù†Ù‚Ø±/Ø§Ù„Ù„Ù…Ø³) Ù„ØªØ­Ø¯ÙŠØ¯ Ù‡Ø¯Ù Ø§Ù„ØªØ³Ø¯ÙŠØ¯.
     * @param {Event} event - Ø­Ø¯Ø« Ø§Ù„Ù†Ù‚Ø± Ø£Ùˆ Ø§Ù„Ù„Ù…Ø³.
     */
    function handleInput(event) {
        if (gameState.phase !== 'aiming') return;

        // ØªØ­Ø¯ÙŠØ¯ Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ø§Ù„Ù†Ù‚Ø±/Ø§Ù„Ù„Ù…Ø³ Ø¯Ø§Ø®Ù„ Canvas
        const rect = canvas.getBoundingClientRect();
        let clientX, clientY;

        if (event.type === 'touchstart') {
            event.preventDefault(); // Ù…Ù†Ø¹ Ø§Ù„ØªÙ…Ø±ÙŠØ± Ø¹Ù„Ù‰ Ø§Ù„Ù„Ù…Ø³
            clientX = event.touches[0].clientX;
            clientY = event.touches[0].clientY;
        } else {
            clientX = event.clientX;
            clientY = event.clientY;
        }

        const scaleX = canvas.width / rect.width;
        const scaleY = canvas.height / rect.height;

        const targetX = (clientX - rect.left) * scaleX;
        const targetY = (clientY - rect.top) * scaleY;

        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù† Ø§Ù„Ù†Ù‚Ø± ÙƒØ§Ù† Ø¯Ø§Ø®Ù„ Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ù‡Ø¯Ù (ÙÙˆÙ‚ Ù†Ù‚Ø·Ø© Ø§Ù„Ø¬Ø²Ø§Ø¡ ÙˆØ¯Ø§Ø®Ù„ Ø§Ù„Ù…Ø±Ù…Ù‰)
        const minX = GAME_WIDTH / 2 - 100;
        const maxX = GAME_WIDTH / 2 + 100;
        const minY = 40;
        const maxY = gameState.ball.initialY - gameState.ball.radius * 2; // Ù„Ø§ ØªØ³Ù…Ø­ Ø¨Ø§Ù„Ù†Ù‚Ø± ØªØ­Øª Ø§Ù„ÙƒØ±Ø©

        if (targetX >= minX && targetX <= maxX && targetY >= minY && targetY <= maxY) {
            gameState.ball.targetX = targetX;
            gameState.ball.targetY = targetY;
            
            // Ø¨Ø¯Ø¡ Ù…Ø±Ø­Ù„Ø© Ø§Ù„ØªØ³Ø¯ÙŠØ¯
            startShot();
        } else {
            messageBox.textContent = "Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ù†Ù‚Ø± Ø¯Ø§Ø®Ù„ Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ù…Ø±Ù…Ù‰!";
            setTimeout(() => {
                messageBox.textContent = "Ø§Ù†Ù‚Ø± (Ø£Ùˆ Ø§Ù„Ù…Ø³ Ø§Ù„Ø´Ø§Ø´Ø©) Ù„ØªØ­Ø¯ÙŠØ¯ Ù‡Ø¯Ù Ø§Ù„ØªØ³Ø¯ÙŠØ¯!";
            }, 1000);
        }
    }

    /**
     * Ø¨Ø¯Ø¡ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªØ³Ø¯ÙŠØ¯ ÙˆØ­Ø±ÙƒØ© Ø­Ø§Ø±Ø³ Ø§Ù„Ù…Ø±Ù…Ù‰.
     */
    function startShot() {
        // Ø¥Ø²Ø§Ù„Ø© Ù…Ø³ØªÙ…Ø¹ Ø§Ù„Ø­Ø¯Ø« Ù„Ù…Ù†Ø¹ Ø§Ù„Ù†Ù‚Ø± Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ³Ø¯ÙŠØ¯
        canvas.removeEventListener('click', handleInput);
        canvas.removeEventListener('touchstart', handleInput);

        gameState.phase = 'shooting';
        messageBox.textContent = "ğŸš€ ØªØ³Ø¯ÙŠØ¯! Ø§Ù†ØªØ¸Ø± Ø§Ù„Ù†ØªÙŠØ¬Ø©...";
        
        // Ø­Ø³Ø§Ø¨ Ø³Ø±Ø¹Ø© Ø§Ù„ÙƒØ±Ø©
        // Ø§Ù„Ù…Ø³Ø§ÙØ© Ø¥Ù„Ù‰ Ø§Ù„Ù‡Ø¯Ù
        const dx = gameState.ball.targetX - gameState.ball.x;
        const dy = gameState.ball.targetY - gameState.ball.y;
        
        // Ù„ØªØ³Ø¯ÙŠØ¯Ø© Ø³Ø±ÙŠØ¹Ø© (Ù…Ø«Ù„Ø§Ù‹ ÙÙŠ 30 Ø®Ø·ÙˆØ© Ø¥Ø·Ø§Ø±)
        const totalSteps = 30; 
        gameState.ball.velocityX = dx / totalSteps;
        gameState.ball.velocityY = dy / totalSteps;
        gameState.ball.active = true;
        
        // Ø§ØªØ®Ø§Ø° Ù‚Ø±Ø§Ø± Ø­Ø§Ø±Ø³ Ø§Ù„Ù…Ø±Ù…Ù‰
        keeperDecision();
    }

    /**
     * Ø§ØªØ®Ø§Ø° Ù‚Ø±Ø§Ø± Ø­Ø§Ø±Ø³ Ø§Ù„Ù…Ø±Ù…Ù‰ (Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ Ø§Ù„Ø¨Ø³ÙŠØ·).
     */
    function keeperDecision() {
        // Ø­Ø§Ø±Ø³ Ø§Ù„Ù…Ø±Ù…Ù‰ ÙŠØ®ØªØ§Ø± Ù…Ù†Ø·Ù‚Ø© Ù…Ù† 9 Ù…Ù†Ø§Ø·Ù‚ (3x3) Ø£Ùˆ ÙŠØ¨Ù‚Ù‰ ÙÙŠ Ø§Ù„ÙˆØ³Ø·
        const zones = [
            { x: GAME_WIDTH / 2 - 70, y: 70 }, // ÙŠØ³Ø§Ø± Ø¹Ù„ÙˆÙŠ
            { x: GAME_WIDTH / 2, y: 70 }, // ÙˆØ³Ø· Ø¹Ù„ÙˆÙŠ
            { x: GAME_WIDTH / 2 + 70, y: 70 }, // ÙŠÙ…ÙŠÙ† Ø¹Ù„ÙˆÙŠ
            { x: GAME_WIDTH / 2 - 70, y: 85 }, // ÙŠØ³Ø§Ø± ÙˆØ³Ø·
            { x: GAME_WIDTH / 2, y: 85 }, // ÙˆØ³Ø·
            { x: GAME_WIDTH / 2 + 70, y: 85 }, // ÙŠÙ…ÙŠÙ† ÙˆØ³Ø·
            { x: GAME_WIDTH / 2 - 70, y: 100 }, // ÙŠØ³Ø§Ø± Ø³ÙÙ„ÙŠ
            { x: GAME_WIDTH / 2, y: 100 }, // ÙˆØ³Ø· Ø³ÙÙ„ÙŠ
            { x: GAME_WIDTH / 2 + 70, y: 100 }  // ÙŠÙ…ÙŠÙ† Ø³ÙÙ„ÙŠ
        ];
        
        // 40% Ø§Ø­ØªÙ…Ø§Ù„ Ø£Ù† ÙŠØ­Ø§ÙˆÙ„ Ø§Ù„Ø­Ø§Ø±Ø³ ØµØ¯ Ø§Ù„ÙƒØ±Ø© ÙÙŠ Ù…ÙƒØ§Ù† Ø§Ù„ØªØ³Ø¯ÙŠØ¯ Ø§Ù„ÙØ¹Ù„ÙŠ.
        // 60% Ø§Ø­ØªÙ…Ø§Ù„ Ø£Ù† ÙŠØ®ØªØ§Ø± Ù†Ù‚Ø·Ø© Ø¹Ø´ÙˆØ§Ø¦ÙŠØ© Ù…Ù† Ø§Ù„Ù€ 9 Ù…Ù†Ø§Ø·Ù‚.
        
        let saveTargetX, saveTargetY;

        if (Math.random() < 0.4) {
             // Ù…Ø­Ø§ÙˆÙ„Ø© ØªÙˆÙ‚Ø¹ Ø§Ù„Ù‡Ø¯Ù (Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù‡Ø¯Ù ÙˆØ§Ø¶Ø­Ø§Ù‹)
             saveTargetX = gameState.ball.targetX;
             saveTargetY = gameState.ball.targetY + 15; // ÙŠØ³ØªÙ‡Ø¯Ù Ø£Ø³ÙÙ„ Ø§Ù„ÙƒØ±Ø© Ù‚Ù„ÙŠÙ„Ø§Ù‹ Ù„Ù„ØµØ¯
        } else {
             // Ø§Ø®ØªÙŠØ§Ø± Ø¹Ø´ÙˆØ§Ø¦ÙŠ Ù„Ù…Ù†Ø·Ù‚Ø© Ø¥Ù†Ù‚Ø§Ø°
             const randomZone = zones[Math.floor(Math.random() * zones.length)];
             saveTargetX = randomZone.x;
             saveTargetY = randomZone.y;
        }

        gameState.keeper.saveX = saveTargetX;
        gameState.keeper.saveY = saveTargetY;
        gameState.keeper.isSaving = true;
    }


    /**
     * ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø­Ø±ÙƒØ© Ø§Ù„ÙƒØ±Ø© ÙˆØ­Ø§Ø±Ø³ Ø§Ù„Ù…Ø±Ù…Ù‰.
     */
    function updateGame() {
        if (gameState.phase === 'shooting' && gameState.ball.active) {
            // ØªØ­Ø¯ÙŠØ« Ù…ÙˆÙ‚Ø¹ Ø§Ù„ÙƒØ±Ø©
            gameState.ball.x += gameState.ball.velocityX;
            gameState.ball.y += gameState.ball.velocityY;

            // ØªØ­Ø¯ÙŠØ¯ Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„ÙƒØ±Ø© Ù‚Ø¯ ÙˆØµÙ„Øª Ø¥Ù„Ù‰ Ø§Ù„Ù‡Ø¯Ù Ø£Ùˆ ØªØ¬Ø§ÙˆØ²ØªÙ‡ Ø¹Ù…ÙˆØ¯ÙŠØ§Ù‹
            const reachedTarget = gameState.ball.velocityY > 0 
                ? gameState.ball.y >= gameState.ball.targetY 
                : gameState.ball.y <= gameState.ball.targetY;

            if (reachedTarget) {
                // Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„ÙƒØ±Ø© Ø¹Ù†Ø¯ Ø§Ù„Ù‡Ø¯Ù Ø¨Ø§Ù„Ø¶Ø¨Ø·
                gameState.ball.x = gameState.ball.targetX;
                gameState.ball.y = gameState.ball.targetY;
                gameState.ball.active = false;
                
                // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù†ØªÙŠØ¬Ø©
                checkGoal();
                
                // Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø¥Ù„Ù‰ Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ù†ØªÙŠØ¬Ø©
                gameState.phase = 'result';
            }

            // ØªØ­Ø¯ÙŠØ« Ù…ÙˆÙ‚Ø¹ Ø­Ø§Ø±Ø³ Ø§Ù„Ù…Ø±Ù…Ù‰ (Ù„Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù†Ø­Ùˆ Ù†Ù‚Ø·Ø© Ø§Ù„ØµØ¯)
            if (gameState.keeper.isSaving) {
                const k = gameState.keeper;
                const speed = 5; // Ø³Ø±Ø¹Ø© Ø­Ø±ÙƒØ© Ø§Ù„Ø­Ø§Ø±Ø³
                
                // ØªØ­Ø±ÙŠÙƒ Ø§Ù„Ø­Ø§Ø±Ø³ Ø£ÙÙ‚ÙŠØ§Ù‹
                if (k.x < k.saveX) {
                    k.x = Math.min(k.x + speed, k.saveX);
                } else if (k.x > k.saveX) {
                    k.x = Math.max(k.x - speed, k.saveX);
                }
            }
        }
    }

    /**
     * Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ù‡Ø¯Ù Ø£Ùˆ ØµØ¯ Ø§Ù„ÙƒØ±Ø©.
     */
    function checkGoal() {
        const ball = gameState.ball;
        const keeper = gameState.keeper;

        // 1. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªÙˆØ§Ø¬Ø¯ Ø¶Ù…Ù† Ø­Ø¯ÙˆØ¯ Ø§Ù„Ù…Ø±Ù…Ù‰ (ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø¯Ø§Ø¦Ù…Ø§Ù‹ Ø¯Ø§Ø®Ù„Ù‡Ø§ Ø¨Ø³Ø¨Ø¨ Ø§Ù„ØªØ­Ù‚Ù‚ ÙÙŠ handleInput)
        // 2. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØµØ¯ (Ù‡Ù„ Ù…ÙˆÙ‚Ø¹ Ø§Ù„ÙƒØ±Ø© ÙŠØªØ¯Ø§Ø®Ù„ Ù…Ø¹ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø­Ø§Ø±Ø³ØŸ)

        // ØªØ­Ø¯ÙŠØ¯ Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ø­Ø§Ø±Ø³ Ø¨Ø¹Ø¯ Ø§Ù„Ø­Ø±ÙƒØ©
        const keeperLeft = keeper.x - keeper.width / 2;
        const keeperRight = keeper.x + keeper.width / 2;
        const keeperTop = keeper.y;
        const keeperBottom = keeper.y + keeper.height;

        // Ø§Ø¹ØªØ¨Ø§Ø± Ø£Ù† Ø§Ù„Ø­Ø§Ø±Ø³ ÙŠØµØ¯ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„ÙƒØ±Ø© ÙÙŠ Ù…Ø³Ø§Ø­Ø© Ø§Ù„ØµØ¯
        const isSavedHorizontally = ball.x + ball.radius > keeperLeft && ball.x - ball.radius < keeperRight;
        const isSavedVertically = ball.y + ball.radius > keeperTop && ball.y - ball.radius < keeperBottom;
        
        let isGoal = true;

        if (isSavedHorizontally && isSavedVertically) {
            // Ù‡Ù†Ø§Ùƒ ØªØ¯Ø§Ø®Ù„ØŒ ØµØ¯Ù‘ Ø§Ù„ÙƒØ±Ø©
            isGoal = false;
        }

        // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù†ØªÙŠØ¬Ø©
        if (isGoal) {
            gameState.score++;
            messageBox.textContent = "ğŸ¥³ Ù‡Ù€Ù€Ù€Ø¯Ù! ØªØ³Ø¯ÙŠØ¯Ø© Ø±Ø§Ø¦Ø¹Ø©!";
        } else {
            messageBox.textContent = "âœ‹ ØµÙ€Ù€Ù€Ø¯! Ø­Ø§Ø±Ø³ Ø§Ù„Ù…Ø±Ù…Ù‰ ÙƒØ§Ù† ÙŠÙ‚Ø¸Ù‹Ø§.";
        }

        // ØªØ­Ø¯ÙŠØ« ÙˆØ¹Ø±Ø¶ Ø²Ø± Ø§Ù„Ø¥Ø¹Ø§Ø¯Ø© Ø¨Ø¹Ø¯ Ø§Ù„ØªØ£Ø®ÙŠØ±
        setTimeout(() => {
            if (gameState.round < MAX_ROUNDS) {
                 gameState.round++;
                 messageBox.textContent += " Ø§Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø²Ø± 'Ø§Ù„Ø¬ÙˆÙ„Ø© Ø§Ù„ØªØ§Ù„ÙŠØ©'.";
            } else {
                 endGame();
                 return;
            }
            restartButton.textContent = "Ø§Ù„Ø¬ÙˆÙ„Ø© Ø§Ù„ØªØ§Ù„ÙŠØ©";
            restartButton.style.display = 'block';
            restartButton.onclick = resetRound;
            updateUI();
        }, 1500); // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù†ØªÙŠØ¬Ø© Ù„Ù…Ø¯Ø© 1.5 Ø«Ø§Ù†ÙŠØ©
    }
    
    /**
     * Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø© ÙˆØ¹Ø±Ø¶ Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©.
     */
    function endGame() {
        cancelAnimationFrame(gameState.animationFrame);
        messageBox.textContent = `Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù„Ø¹Ø¨Ø©! Ù†ØªÙŠØ¬ØªÙƒ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© Ù‡ÙŠ: ${gameState.score} Ù…Ù† ${MAX_ROUNDS}.`;
        restartButton.textContent = "Ø¥Ø¹Ø§Ø¯Ø© Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø©";
        restartButton.style.display = 'block';
        
        // **********************************************
        // FIX: Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„ Ø­Ù„Ù‚Ø© Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ù…ØªØ­Ø±ÙƒØ© (gameLoop) 
        // Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø¥Ø¹Ø§Ø¯Ø© Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø© Ù„Ø¶Ù…Ø§Ù† Ø§Ø³ØªÙ…Ø±Ø§Ø± Ø§Ù„Ø­Ø±ÙƒØ©
        // **********************************************
        restartButton.onclick = () => {
            gameState.score = 0;
            gameState.round = 1;
            gameLoop(); // Ø¥Ø¶Ø§ÙØ© Ù‡Ø°Ù‡ Ø§Ù„Ø¯Ø§Ù„Ø© Ù„Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„ Ø§Ù„Ø£Ù†Ù…ÙŠØ´Ù†
            resetRound();
        };
    }

    // ----------------------
    // Ø­Ù„Ù‚Ø© Ø§Ù„Ù„Ø¹Ø¨Ø© (Game Loop)
    // ----------------------

    /**
     * Ø§Ù„Ø­Ù„Ù‚Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ù„Ù„Ø¹Ø¨Ø© (ØªÙØ³ØªØ¯Ø¹Ù‰ 60 Ù…Ø±Ø© ÙÙŠ Ø§Ù„Ø«Ø§Ù†ÙŠØ©).
     */
    function gameLoop() {
        // 1. Ù…Ø³Ø­ Ø§Ù„ÙƒØ§Ù†ÙØ§Ø³ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„
        ctx.clearRect(0, 0, GAME_WIDTH, GAME_HEIGHT);
        
        // 2. Ø§Ù„Ø±Ø³Ù… Ø¨Ø§Ù„ØªØ±ØªÙŠØ¨ (Ù…Ù† Ø§Ù„Ø®Ù„Ù Ø¥Ù„Ù‰ Ø§Ù„Ø£Ù…Ø§Ù…)
        drawField();
        drawKeeper();
        drawBall();
        drawTarget(); // Ø±Ø³Ù… Ø§Ù„Ù…Ø¤Ø´Ø± Ø¥Ø°Ø§ ÙƒØ§Ù† ÙÙŠ Ù…Ø±Ø­Ù„Ø© Ø§Ù„ØªØµÙˆÙŠØ¨

        // 3. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù†Ø·Ù‚ (Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„ÙƒØ±Ø© ÙÙŠ Ø­Ø§Ù„Ø© Ø­Ø±ÙƒØ©)
        updateGame();
        
        // 4. Ø·Ù„Ø¨ Ø§Ù„Ø¥Ø·Ø§Ø± Ø§Ù„ØªØ§Ù„ÙŠ
        gameState.animationFrame = requestAnimationFrame(gameLoop);
    }

    // ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù„Ø¹Ø¨Ø© Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
    window.onload = function() {
        // ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„ÙƒØ§Ù†ÙØ§Ø³ ÙŠØªÙ…ØªØ¹ Ø¨Ù†Ø³Ø¨Ø© Ø¹Ø±Ø¶ Ø¥Ù„Ù‰ Ø§Ø±ØªÙØ§Ø¹ Ø¬ÙŠØ¯Ø© Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø©
        const resizeCanvas = () => {
            const container = canvas.parentElement;
            const containerWidth = container.clientWidth;
            // Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ù†Ø³Ø¨Ø© Ø§Ù„Ø¹Ø±Ø¶/Ø§Ù„Ø§Ø±ØªÙØ§Ø¹ 5:4
            canvas.style.height = `${(containerWidth / GAME_WIDTH) * GAME_HEIGHT}px`;
        };

        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();
        
        // Ø¨Ø¯Ø¡ Ø§Ù„Ù„Ø¹Ø¨Ø©
        gameLoop();
        resetRound(); 
    };
</script>

</body>
</html>
